import subprocess
import os
import sys
import time
from pathlib import Path

def install_and_launch_openwebui():
    """Установка и запуск Open WebUI"""
    
    openwebui_dir = Path("./open-webui")
    
    # Шаг 1: Клонирование репозитория
    if not openwebui_dir.exists():
        print("Клонирование Open WebUI...")
        result = subprocess.run([
            "git", "clone", "https://github.com/open-webui/open-webui.git", 
            str(openwebui_dir)
        ])
        if result.returncode != 0:
            print("Ошибка клонирования")
            return False
    
    os.chdir(openwebui_dir)
    
    # Шаг 2: Проверка Node.js
    print("Проверка Node.js...")
    node_check = subprocess.run(["node", "--version"], capture_output=True, text=True)
    if node_check.returncode != 0:
        print("Node.js не установлен. Установите Node.js 18+")
        return False
    
    # Шаг 3: Установка зависимостей
    print("Установка зависимостей...")
    if not (openwebui_dir / "node_modules").exists():
        result = subprocess.run(["npm", "ci"])
        if result.returncode != 0:
            print("Ошибка установки зависимостей")
            return False
    
    # Шаг 4: Сборка
    print("Сборка проекта...")
    if not (openwebui_dir / "dist").exists():
        result = subprocess.run(["npm", "run", "build"])
        if result.returncode != 0:
            print("Ошибка сборки")
            return False
    
    # Шаг 5: Настройка конфигурации
    config_content = f"""
# Конфигурация для подключения к vLLM
{{
  "oidc": {{
    "CLIENT_ID": "http://localhost:3000"
  }},
  "environment_variables": {{
    "OLLAMA_BASE_URL": "http://localhost:8000/v1",
    "WEBUI_AUTH": "False",
    "WEBUI_NAME": "RAG System",
    "WEBUI_URL": "http://localhost:3000"
  }}
}}
"""
    
    config_file = openwebui_dir / "backend" / "config.json"
    config_file.parent.mkdir(parents=True, exist_ok=True)
    config_file.write_text(config_content)
    
    # Шаг 6: Запуск
    print("Запуск Open WebUI...")
    print("Адрес: http://localhost:3000")
    print("Подключение к vLLM: http://localhost:8000/v1")
    
    # Запуск в фоновом режиме
    process = subprocess.Popen([
        "npm", "run", "start"
    ])
    
    print(f"Open WebUI запущен (PID: {process.pid})")
    print("Для остановки: Ctrl+C")
    
    try:
        process.wait()
    except KeyboardInterrupt:
        print("\nОстановка Open WebUI...")
        process.terminate()
    
    return True

if __name__ == "__main__":
    install_and_launch_openwebui()
