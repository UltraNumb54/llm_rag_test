<!doctype html>
<html lang="ru">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Ассистент технической поддержки</title>
        <style>
            /* Ваш CSS код остаётся без изменений */
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
                line-height: 1.6;
                color: #333;
                background-color: #f5f7fa;
                min-height: 100vh;
            }

            /* ... остальной CSS код ... */
        </style>
    </head>
    <body>
        <div class="app-container">
            <!-- Header -->
            <div class="header">
                <h1>RAG Ассистент технической поддержки</h1>
                <div class="header-actions">
                    <button class="new-chat-btn" onclick="createNewChat()">
                        + Новый чат
                    </button>
                </div>
            </div>

            <!-- Left Chats Panel -->
            <div class="chats-panel">
                <div class="chats-header">Мои чаты</div>
                <div class="chats-list" id="chatsList">
                    <!-- Chat items will be dynamically added here -->
                </div>
            </div>

            <!-- Main Chat Area -->
            <div class="chat-container">
                <div class="chat-messages" id="chat">
                    <div class="message system">
                        Добро пожаловать! Создайте новый чат или выберите существующий.
                    </div>
                </div>
                <div class="input-area">
                    <input
                        type="text"
                        id="message"
                        placeholder="Введите ваш вопрос..."
                        autocomplete="off"
                        disabled
                    />
                    <button onclick="sendMessage()" id="sendBtn" disabled>
                        Отправить
                    </button>
                </div>
            </div>

            <!-- Right Sidebar -->
            <div class="sidebar">
                <div class="upload-section" id="uploadSection">
                    <h3>Загрузка документов</h3>
                    <input
                        type="file"
                        id="fileInput"
                        accept=".pdf,.docx,.txt,.md"
                    />
                    <button onclick="uploadFile()">Загрузить файл</button>
                    <div id="uploadStatus"></div>
                </div>
            </div>
        </div>

        <script>
            // State management
            let chats = JSON.parse(localStorage.getItem("rag-chats")) || [];
            let currentChatId = null;
            let showUploadSection = true;

            // Initialize the app
            document.addEventListener("DOMContentLoaded", function () {
                initializeApp();
            });

            function initializeApp() {
                renderChatsList();
                updateUploadSectionVisibility();

                // Focus on message input
                document.getElementById("message").focus();

                // Enter key support
                document.getElementById("message").addEventListener("keypress", function (e) {
                    if (e.key === "Enter") {
                        sendMessage();
                    }
                });

                // Load last active chat if exists
                if (chats.length > 0) {
                    const lastActiveChat = chats.find((chat) => chat.isActive) || chats[chats.length - 1];
                    switchChat(lastActiveChat.id);
                }
            }

            function updateUploadSectionVisibility() {
                const uploadSection = document.getElementById("uploadSection");
                if (showUploadSection) {
                    uploadSection.classList.remove("hidden");
                } else {
                    uploadSection.classList.add("hidden");
                }
            }

            // Chat management functions
            function createNewChat() {
                const chatId = "chat-" + Date.now();
                const newChat = {
                    id: chatId,
                    title: "Новый чат " + (chats.length + 1),
                    messages: [],
                    createdAt: new Date().toISOString(),
                    isActive: true,
                };

                // Deactivate all other chats
                chats.forEach((chat) => (chat.isActive = false));

                chats.unshift(newChat);
                saveChats();
                renderChatsList();
                switchChat(chatId);

                // Enable input
                document.getElementById("message").disabled = false;
                document.getElementById("sendBtn").disabled = false;
            }

            function switchChat(chatId) {
                // Deactivate all chats
                chats.forEach((chat) => (chat.isActive = false));

                // Activate selected chat
                const selectedChat = chats.find((chat) => chat.id === chatId);
                if (selectedChat) {
                    selectedChat.isActive = true;
                    currentChatId = chatId;
                    renderChatMessages(selectedChat.messages);
                    updateChatTitle(chatId, selectedChat.title);
                }

                saveChats();
                renderChatsList();
            }

            function deleteChat(chatId, event) {
                event.stopPropagation();

                if (confirm("Вы уверены, что хотите удалить этот чат?")) {
                    chats = chats.filter((chat) => chat.id !== chatId);

                    if (currentChatId === chatId) {
                        currentChatId = null;
                        document.getElementById("chat").innerHTML =
                            '<div class="message system">Выберите чат или создайте новый</div>';
                        document.getElementById("message").disabled = true;
                        document.getElementById("sendBtn").disabled = true;
                    }

                    saveChats();
                    renderChatsList();
                }
            }

            function editChatTitle(chatId, event) {
                event.stopPropagation();

                const chatItem = event.target.closest(".chat-item");
                const titleElement = chatItem.querySelector(".chat-title");
                const currentTitle = titleElement.textContent;

                const input = document.createElement("input");
                input.type = "text";
                input.className = "chat-title-input";
                input.value = currentTitle;

                titleElement.replaceWith(input);
                input.focus();
                input.select();

                function saveTitle() {
                    const newTitle = input.value.trim() || currentTitle;
                    updateChatTitle(chatId, newTitle);
                    renderChatsList();
                }

                input.addEventListener("blur", saveTitle);
                input.addEventListener("keypress", function (e) {
                    if (e.key === "Enter") {
                        saveTitle();
                    }
                });
            }

            function updateChatTitle(chatId, newTitle) {
                const chat = chats.find((chat) => chat.id === chatId);
                if (chat) {
                    chat.title = newTitle;
                    saveChats();
                }
            }

            // Rendering functions
            function renderChatsList() {
                const chatsList = document.getElementById("chatsList");
                chatsList.innerHTML = "";

                if (chats.length === 0) {
                    chatsList.innerHTML =
                        '<div style="padding: 15px; color: #666; text-align: center;">Нет сохраненных чатов</div>';
                    return;
                }

                chats.forEach((chat) => {
                    const chatItem = document.createElement("div");
                    chatItem.className = `chat-item ${chat.isActive ? "active" : ""}`;
                    chatItem.onclick = () => switchChat(chat.id);

                    chatItem.innerHTML = `
                    <div class="chat-title">${escapeHtml(chat.title)}</div>
                    <div class="chat-actions">
                        <button class="delete-chat" onclick="deleteChat('${chat.id}', event)">×</button>
                    </div>
                `;

                    // Double click to edit title
                    chatItem.ondblclick = (e) => editChatTitle(chat.id, e);

                    chatsList.appendChild(chatItem);
                });
            }

            function renderChatMessages(messages) {
                const chatContainer = document.getElementById("chat");
                chatContainer.innerHTML = "";

                if (messages.length === 0) {
                    chatContainer.innerHTML =
                        '<div class="message system">Задайте ваш первый вопрос</div>';
                    return;
                }

                messages.forEach((msg) => {
                    addMessage(msg.role, msg.content, false, false);
                });
            }

            function addMessage(role, content, isTyping = false, saveToHistory = true) {
                const chatContainer = document.getElementById("chat");
                const messageDiv = document.createElement("div");
                messageDiv.className = `message ${role}`;

                if (isTyping) {
                    messageDiv.innerHTML = `
                    <strong>Ассистент:</strong>
                    <span class="typing-indicator">
                        Обработка запроса
                        <span class="typing-dots">
                            <span>.</span><span>.</span><span>.</span>
                        </span>
                    </span>
                `;
                } else {
                    const roleNames = {
                        user: "Вы",
                        assistant: "Ассистент",
                        system: "Система",
                        error: "Ошибка",
                    };

                    messageDiv.innerHTML = `<strong>${roleNames[role]}:</strong> ${escapeHtml(content)}`;
                }

                chatContainer.appendChild(messageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;

                // Save to current chat history
                if (saveToHistory && currentChatId && !isTyping) {
                    const currentChat = chats.find((chat) => chat.id === currentChatId);
                    if (currentChat) {
                        currentChat.messages.push({
                            role,
                            content,
                            timestamp: new Date().toISOString(),
                        });
                        saveChats();
                    }
                }

                return messageDiv;
            }

            // Message sending
            async function sendMessage() {
                const messageInput = document.getElementById("message");
                const sendBtn = document.getElementById("sendBtn");
                const message = messageInput.value.trim();

                if (!message || !currentChatId) return;

                // Add user message
                addMessage("user", message);
                messageInput.value = "";
                messageInput.disabled = true;
                sendBtn.disabled = true;
                sendBtn.textContent = "Отправка...";

                // Show typing indicator
                const typingIndicator = addMessage("assistant", "", true, false);

                try {
                    const response = await fetch("/api/v1/chat", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            message: message,
                            conversation_id: currentChatId,
                        }),
                    });

                    // Remove typing indicator
                    typingIndicator.remove();

                    if (!response.ok) {
                        throw new Error(`Ошибка HTTP: ${response.status}`);
                    }

                    const data = await response.json();
                    addMessage("assistant", data.response);

                    if (data.sources && data.sources.length > 0) {
                        addMessage(
                            "system",
                            `Использованные источники: ${data.sources.join(", ")}`,
                        );
                    }
                } catch (error) {
                    // Remove typing indicator
                    typingIndicator.remove();
                    addMessage("error", `Ошибка соединения: ${error.message}`);
                } finally {
                    messageInput.disabled = false;
                    sendBtn.disabled = false;
                    sendBtn.textContent = "Отправить";
                    messageInput.focus();
                }
            }

            // File upload
            async function uploadFile() {
                const fileInput = document.getElementById("fileInput");
                const uploadStatus = document.getElementById("uploadStatus");
                const file = fileInput.files[0];

                if (!file) {
                    uploadStatus.innerHTML = '<span style="color: #dc3545;">Выберите файл</span>';
                    return;
                }

                const formData = new FormData();
                formData.append("file", file);

                uploadStatus.innerHTML = '<span style="color: #007bff;">Загрузка...</span>';

                try {
                    const response = await fetch("/api/v1/upload", {
                        method: "POST",
                        body: formData,
                    });

                    const result = await response.json();

                    if (response.ok) {
                        uploadStatus.innerHTML = `<span style="color: #28a745;">${result.message}</span>`;
                        fileInput.value = "";

                        // Add system message about successful upload
                        if (currentChatId) {
                            addMessage(
                                "system",
                                `Файл "${file.name}" успешно загружен и обработан`,
                            );
                        }
                    } else {
                        uploadStatus.innerHTML = `<span style="color: #dc3545;">Ошибка: ${result.detail || "Неизвестная ошибка"}</span>`;
                    }
                } catch (error) {
                    uploadStatus.innerHTML = `<span style="color: #dc3545;">Ошибка сети: ${error.message}</span>`;
                }
            }

            // Utility functions
            function saveChats() {
                localStorage.setItem("rag-chats", JSON.stringify(chats));
            }

            function escapeHtml(unsafe) {
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

            // Set upload section visibility
            function setUploadSectionVisibility(visible) {
                showUploadSection = visible;
                updateUploadSectionVisibility();
            }
        </script>
    </body>
</html>
